name: Bump version

on:
  push:
    branches:
      - master
env:
  HELM_EXPERIMENTAL_OCI: 1
  ACR_NAME: acrdemoutkarsh
  ACR_REPO_NAME: helm/michsi-app


permissions:
  contents: write
  pull-requests: write

jobs:
  semantic-release:
    runs-on: ubuntu-latest
    steps:
      # Checkout repo
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 'lts/*'

      - name: Install dependencies
        run: npm install

      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release

      - name: Get version
        id: get_version
        run: |
          echo "VERSION=$(cat Chart.yaml | grep version | awk '{print $2}')"
          echo "$VERSION" >> $GITHUB_OUTPUT

      - name: Commit Chart.yaml
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'chore(release) bump version to ${{ steps.get_version.outputs.VERSION }}'
          file_pattern: 'Chart.yaml'

  build:
    name: publish acr
    runs-on: ubuntu-latest
    environment: prod
    needs: semantic-release
    steps:
      - uses: actions/checkout@v2
        name: checkout repo
      
      - name: install helm
        uses: Azure/setup-helm@v1
        with:
          version: 'v3.6.3'

      - name: login to acr using helm
        run: |
          echo $ | helm registry login ${{ secrets.ACR_URL }} --username ${{ secrets.ACR_PUSH_USER }} --password ${{ secrets.ACR_PUSH_TOKEN }} 

      - name: Get version
        id: get_version
        run: |
          export "VERSION=$(cat Chart.yaml | grep version | awk '{print $2}' | awk -F. -v OFS=. '{$NF++; print}')"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Get Chart name
        id: get_chart
        run: |
          export "CHART=$(cat Chart.yaml | grep name | awk '{print $2}')"
          echo "CHART=$CHART" >> $GITHUB_ENV

      - name: save helm chart to local registry
        run: |
          helm chart save . ${{ secrets.ACR_URL }}/${{ env.CHART }}:${{ env.VERSION }}
            
      - name: publish chart to acr
        run: |
          helm chart push ${{ secrets.ACR_URL }}/${{ env.CHART }}:${{ env.VERSION }}
